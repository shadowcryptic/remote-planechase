<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Display Debug</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: black; /* looks nice on a monitor */
        overflow: hidden;
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #card {
        transform: rotate(90deg);
        transform-origin: center center;

        /* Scale to fit screen */
        max-width: 100vh;
        max-height: 100vw;

        width: auto;
        height: auto;

        object-fit: contain;
      }
    </style>
  </head>
  <body>
    <div id="status">Bootingâ€¦</div>
    <pre id="dump"></pre>
    <img id="card" alt="">

    <script type="module">
      import {
        db,
        doc,
        onSnapshot,
        setDoc,
        runTransaction,
        serverTimestamp,
      } from "./common.js";

      const roomRef = doc(db, "rooms", "my-room");

      async function loadDeck() {
        const res = await fetch("./deck.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load deck.json");
        const data = await res.json();
        return Array.isArray(data.deck) ? data.deck : [];
      }

      function shuffledIndices(n) {
        const a = [];
        for (let i = 0; i < n; i++) a.push(i);
        for (let i = n - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          const tmp = a[i];
          a[i] = a[j];
          a[j] = tmp;
        }
        return a;
      }

      const deck = await loadDeck();

      // Ensure Firestore has an order matching deck length (runtime shuffle)
      await runTransaction(db, async (tx) => {
        const snap = await tx.get(roomRef);
        const existing = snap.exists() ? snap.data() : {};
        const order = Array.isArray(existing.order) ? existing.order : [];

        if (order.length !== deck.length) {
          tx.set(
            roomRef,
            {
              order: shuffledIndices(deck.length),
              idx: 0,
              shuffledAt: serverTimestamp(),
            },
            { merge: true },
          );
        }
      });

      // Now just listen + render
      onSnapshot(roomRef, (snap) => {
        const data = snap.exists() ? snap.data() : {};
        const order = Array.isArray(data.order) ? data.order : [];
        const idx = typeof data.idx === "number" ? data.idx : 0;

        const deckIndex = order[idx] ?? 0;
        const url = deck[deckIndex];

        document.getElementById("card").src = url || "";
      });
    </script>
  </body>
</html>
