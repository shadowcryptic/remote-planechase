<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Display</title>
  <style>
    body {
      font-family: sans-serif;
      font-size: 4rem;
      text-align: center;
      margin-top: 20vh;
    }
  </style>
</head>
<body>

<div id="output">Waitingâ€¦</div>


<script type="module">
  import "./common.js";
  import { runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const roomId = "my-room";
  const { db, doc, onSnapshot } = window.firebaseState;

  const roomRef = doc(db, "rooms", roomId);

  function shuffledIndices(n) {
    const a = [];
    for (let i = 0; i < n; i++) a.push(i);
    for (let i = n - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const tmp = a[i];
      a[i] = a[j];
      a[j] = tmp;
    }
    return a;
  }

  async function ensureShuffled(deckLength) {
    await runTransaction(db, async (tx) => {
      const snap = await tx.get(roomRef);
      if (!snap.exists()) return;

      const data = snap.data();
      const order = Array.isArray(data.order) ? data.order : [];

      // If already shuffled, do nothing
      if (order.length === deckLength && deckLength > 0) return;

      // Create a new random order
      const orderNew = shuffledIndices(deckLength);
      tx.set(roomRef, {
        order: orderNew,
        idx: 0,
        shuffledAt: serverTimestamp()
      }, { merge: true });
    });
  }

  onSnapshot(roomRef, (snap) => {
    if (!snap.exists()) return;

    const data = snap.data();
    const deck = Array.isArray(data.deck) ? data.deck : [];

    // If we have a deck but no valid order yet, shuffle at runtime
    if (deck.length > 0) {
      const order = Array.isArray(data.order) ? data.order : [];
      if (order.length !== deck.length) {
        ensureShuffled(deck.length);
      }
    }
  });
</script>


</body>
</html>