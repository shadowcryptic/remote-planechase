<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Display Debug</title>
<style>
/* Flip stage stays at your target size */
.flip-stage{
  width: 680px;
  height: 488px;
  display: grid;
  place-items: center;
  perspective: 1200px;
}

.flip-card{
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 420ms cubic-bezier(.2,.8,.2,1);
}

.flip-card.is-flipped{
  transform: rotateY(180deg);
}

.flip-face{
  position: absolute;
  inset: 0;
  backface-visibility: hidden;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 18px 40px rgba(0,0,0,0.55);
  border: 1px solid rgba(255,255,255,0.10);
  display: grid;
  place-items: center;
}

.flip-back{
  transform: rotateY(180deg);
  background: #0b0f14;
}

/* ðŸ”‘ IMAGE RULES */
#card{
  /* rotate the IMAGE, not the card */
  transform: rotate(90deg);
  transform-origin: center;

  /* shrink-only behavior */
  max-width: 488px;   /* swapped because rotated */
  max-height: 680px;

  width: auto;
  height: auto;

  object-fit: contain;
  display: block;
}

</style>

  </head>
  <body>
    <div id="status">Bootingâ€¦</div>
    <pre id="dump"></pre>
<div class="flip-stage">
  <div class="flip-card" id="flip">
    <div class="flip-face flip-front">
      <img id="card" alt="">
    </div>
    <div class="flip-face flip-back">
      <div class="back-pattern">PLANECHASE</div>
    </div>
  </div>
</div>


    <script type="module">
      import {
        db,
        doc,
        onSnapshot,
        setDoc,
        runTransaction,
        serverTimestamp,
      } from "./common.js";

      const roomRef = doc(db, "rooms", "my-room");

      async function loadDeck() {
        const res = await fetch("./deck.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load deck.json");
        const data = await res.json();
        return Array.isArray(data.deck) ? data.deck : [];
      }

      function shuffledIndices(n) {
        const a = [];
        for (let i = 0; i < n; i++) a.push(i);
        for (let i = n - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          const tmp = a[i];
          a[i] = a[j];
          a[j] = tmp;
        }
        return a;
      }

      const flipEl = document.getElementById("flip");
const imgEl = document.getElementById("card");

let currentUrl = "";

function flipToUrl(nextUrl) {
  if (!nextUrl || nextUrl === currentUrl) return;

  flipEl.classList.add("is-flipped");

  setTimeout(() => {
    imgEl.onload = () => {
      flipEl.classList.remove("is-flipped");
    };
    imgEl.src = nextUrl;
    currentUrl = nextUrl;
  }, 220);
}


      const deck = await loadDeck();

      // Ensure Firestore has an order matching deck length (runtime shuffle)
      await runTransaction(db, async (tx) => {
        const snap = await tx.get(roomRef);
        const existing = snap.exists() ? snap.data() : {};
        const order = Array.isArray(existing.order) ? existing.order : [];

        if (order.length !== deck.length) {
          tx.set(
            roomRef,
            {
              order: shuffledIndices(deck.length),
              idx: 0,
              shuffledAt: serverTimestamp(),
            },
            { merge: true },
          );
        }
      });

      // Now just listen + render
      onSnapshot(roomRef, (snap) => {
        const data = snap.exists() ? snap.data() : {};
        const order = Array.isArray(data.order) ? data.order : [];
        const idx = typeof data.idx === "number" ? data.idx : 0;

        const deckIndex = order[idx] ?? 0;
        const url = deck[deckIndex];

        document.getElementById("card").src = url || "";
      });
    </script>
  </body>
</html>
